global
        log 127.0.0.1   local0
        log 127.0.0.1   local1 notice
        #log loghost    local0 info
        maxconn 4096
        #debug
        #quiet
        user haproxy
        group haproxy

defaults
        log     global
        mode    http
        option  httplog
        option  dontlognull
        retries 3
        option redispatch
        maxconn 2000
        contimeout      5000
        clitimeout      50000
        srvtimeout      50000
        <% if node['haproxy']['x_forwarded_for'] -%>
        option httpclose
        option forwardfor
        <% end -%>


<% node['haproxy']['proxies'].each do |proxy| %>
  listen <%= proxy['name'] %> 0.0.0.0:<%= proxy['incoming_port'] %>
    balance <%= node['haproxy']['balance_algorithm'] %>
    <% if proxy['options'] %>
    <% proxy['options'].each do |option| %>
    <%= option %>
    <% end -%>
    <% end -%>
    <% @pool_members.each do |member| -%>
    server <%= member[:hostname] %> <%= member[:ipaddress] %>:<%= proxy['outgoing_port'] %> weight 1 maxconn <%= node['haproxy']['member_max_connections'] %> check
    <% end -%>

<% end -%>

<% if node['haproxy']['enable_admin'] -%>
listen admin 0.0.0.0:22002
  mode http
  stats uri /
<% end -%>
